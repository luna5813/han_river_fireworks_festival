<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ì„œìš¸ ë¶ˆê½ƒì¶•ì œ ì‹¤ì‹œê°„ ëª…ë‹¹ ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Pretendard', sans-serif; }
        .header { background: linear-gradient(135deg,#ff6b6b,#ee5a6f); color:#fff; padding:15px; text-align:center; position: relative; z-index: 1001; }
        #map { width:100vw; height: calc(100vh - 82px); background: #f0f0f0; } /* ê¸°ë³¸ ë°°ê²½ìƒ‰ */
        .firework-icon { display: flex !important; align-items: center; justify-content: center; font-size: 30px !important; background: radial-gradient(circle, rgba(255,255,0,0.9) 0%, rgba(255,165,0,0.2) 70%); border-radius: 50%; border: 2px solid #ff4500; animation: firework-pulse 1.2s infinite; z-index: 1000 !important; }
        @keyframes firework-pulse { 0% { transform: scale(1); } 70% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .control-panel { position: fixed; top:100px; right:20px; z-index:1000; }
        .add-btn { padding:14px 24px; background:#4facfe; color:white; border:none; border-radius:50px; cursor:pointer; font-weight:bold; box-shadow:0 6px 20px rgba(0,0,0,0.2); }
        .legend { position: fixed; bottom:30px; left:20px; background:white; padding:15px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.1); z-index:1000; font-size: 13px; }
        .popup-form { min-width: 200px; }
        .popup-form input, .popup-form textarea, .popup-form select { width: 100%; margin-bottom: 8px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .save-btn { width: 100%; padding: 12px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
<div class="header"><h1>ğŸ† ì‹¤ì‹œê°„ ë¶ˆê½ƒ ëª…ë‹¹ ì§€ë„ ğŸ‡</h1></div>
<div id="map"></div>
<div class="control-panel"><button class="add-btn" onclick="enableAddSpot()">ğŸ“ ë‚´ ëª…ë‹¹ ì œë³´í•˜ê¸°</button></div>
<div class="legend"><strong>ğŸ¨ ì•„ì´ì½˜ ì•ˆë‚´</strong><div style="margin-top:5px">ğŸ‡ ë¶ˆê½ƒ ë°œì‚¬ ì§€ì </div><div>â­ ìµœê³  ëª…ë‹¹</div><div>âœ¨ ìš°ìˆ˜ ëª…ë‹¹</div><div>ğŸ“ ì¼ë°˜ ëª…ë‹¹</div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
    const firebaseConfig = { databaseURL: "https://fireworks-map-50c05-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const map = L.map('map', { zoomControl: false }).setView([37.5255, 126.9405], 14);
    
    // [ìˆ˜ì •ëœ ë¶€ë¶„] ê°€ì¥ ì•ˆì •ì ì¸ OSM íƒ€ì¼ ë ˆì´ì–´
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    function addFireworkZones() {
        [[37.5255, 126.9405], [37.5228, 126.9472]].forEach(coords => {
            L.marker(coords, { icon: L.divIcon({ className: 'firework-icon', html: 'ğŸ‡', iconSize: [40, 40], iconAnchor: [20, 20] }) }).addTo(map);
            L.circle(coords, { color: '#ff4500', fillColor: '#ffcc00', fillOpacity: 0.15, radius: 250 }).addTo(map);
        });
    }
    addFireworkZones();

    function getCustomIcon(rating) {
        let iconHtml = 'ğŸ“'; let bgColor = '#4facfe';
        if (rating === "â­â­â­â­â­") { iconHtml = 'â­'; bgColor = '#FFD700'; }
        else if (rating === "â­â­â­â­") { iconHtml = 'âœ¨'; bgColor = '#C0C0C0'; }
        return L.divIcon({ html: `<div style="background:${bgColor}; width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px; color:white; border:2px solid white; shadow: 0 3px 8px rgba(0,0,0,0.2);">${iconHtml}</div>`, className: '', iconSize: [34, 34], iconAnchor: [17, 17] });
    }

    database.ref('spots').on('child_added', (snapshot) => {
        const data = snapshot.val();
        L.marker([data.lat, data.lng], { icon: getCustomIcon(data.rating) }).bindPopup(`<strong>${data.name}</strong><br>${data.rating}<p>${data.reason}</p>`).addTo(map);
    });

    window.enableAddSpot = function() { new L.Draw.Marker(map).enable(); };
    map.on(L.Draw.Event.CREATED, function (e) {
        const latlng = e.layer.getLatLng();
        const id = Date.now();
        const content = `<div class="popup-form"><h4>ğŸ“ ì •ë³´ ì…ë ¥</h4><input type="text" id="name_${id}" placeholder="ì¥ì†Œëª…"><textarea id="reason_${id}" placeholder="ì¶”ì²œ ì´ìœ "></textarea><select id="rating_${id}"><option value="â­â­â­â­â­">â­ ìµœê³ </option><option value="â­â­â­â­">âœ¨ ìš°ìˆ˜</option><option value="â­â­â­">ğŸ“ ì¼ë°˜</option></select><button class="save-btn" onclick="saveToFirebase(${latlng.lat}, ${latlng.lng}, ${id})">ê³µìœ í•˜ê¸°</button></div>`;
        L.popup().setLatLng(latlng).setContent(content).openOn(map);
    });

    window.saveToFirebase = function(lat, lng, id) {
        const name = document.getElementById(`name_${id}`).value;
        const reason = document.getElementById(`reason_${id}`).value;
        const rating = document.getElementById(`rating_${id}`).value;
        if(name && reason) { database.ref('spots').push({ name, reason, rating, lat, lng, time: new Date().toISOString() }).then(() => map.closePopup()); }
    };
</script>
</body>
</html>
