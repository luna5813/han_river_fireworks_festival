<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>2026 ì—¬ì˜ë„ ë¶ˆê½ƒì¶•ì œ ì‹¤ì‹œê°„ ì§€ë„</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2QF8M7WFVJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-2QF8M7WFVJ'); 
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        #map { width: 100vw; height: 100vh; z-index: 1; }
        .header { position: absolute; top: 0; left: 0; right: 0; background: rgba(26, 26, 46, 0.85); color:#fff; padding: 6px 0; text-align:center; z-index: 1001; border-bottom: 1px solid rgba(255, 107, 107, 0.5); }
        .header h1 { margin:0; font-size: 14px; font-weight: 500; }
        .control-panel { position: fixed; top: 45px; right: 12px; z-index: 1000; }
        .add-btn { padding: 8px 16px; background: #ff6b6b; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 13px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .add-btn.active { background: #2ecc71; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .legend { position: fixed; bottom: 20px; left: 12px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 10px; z-index: 1000; font-size: 11px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid #eee; line-height: 1.6; }
        .status-badge { display: inline-block; padding: 1px 4px; border-radius: 3px; font-size: 9px; color: white; font-weight: bold; margin-left: 5px; }
        .pending-tag { background: #95a5a6; } .verified-tag { background: #3498db; }
        .vote-btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .up-btn { flex: 1; background: #3498db; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; }
        .down-btn { flex: 1; background: #e74c3c; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; }
        .popup-form { min-width: 170px; }
        .popup-form input, .popup-form textarea, .popup-form select { width: 100%; margin-bottom: 6px; padding: 8px; border-radius: 4px; border: 1px solid #ddd; font-size: 13px; box-sizing: border-box; }
        .save-btn { width: 100%; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="header"><h1>ğŸ‡ 2026 ì—¬ì˜ë„ ë¶ˆê½ƒì¶•ì œ ì§€ë„</h1></div>
<div id="map"></div>
<div class="control-panel"><button id="addBtn" class="add-btn" onclick="toggleAddMode()">ğŸ“ ëª…ë‹¹ ì œë³´</button></div>

<div class="legend">
    <strong>ğŸ‡ ë°œì‚¬ ìœ„ì¹˜</strong> | ğŸš½ í™”ì¥ì‹¤ | ğŸª í¸ì˜ì <br>
    ğŸ”µ ì¸ì¦ ëª…ë‹¹ | âšª í™•ì¸ ì¤‘ (íë¦¼)
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    firebase.initializeApp({ databaseURL: "https://fireworks-map-50c05-default-rtdb.firebaseio.com/" });
    const database = firebase.database();

    const map = L.map('map', { zoomControl: false }).setView([37.527, 126.945], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // [ì²´í¬] í¸ì˜ì‹œì„¤
    const facilities = [
        { name: "ì—¬ì˜ë„ 3í˜¸ ë§¤ì (í¸ì˜ì )", lat: 37.5300, lng: 126.9310, type: "ğŸª" },
        { name: "ì—¬ì˜ë„ 2í˜¸ ë§¤ì (í¸ì˜ì )", lat: 37.5270, lng: 126.9340, type: "ğŸª" },
        { name: "ì—¬ì˜ë„ ì•ˆë‚´ì„¼í„° í™”ì¥ì‹¤", lat: 37.5285, lng: 126.9335, type: "ğŸš½" },
        { name: "ë§ˆí¬ëŒ€êµ ë‚¨ë‹¨ í™”ì¥ì‹¤", lat: 37.5325, lng: 126.9295, type: "ğŸš½" },
        { name: "ì›íš¨ëŒ€êµ ë‚¨ë‹¨ í™”ì¥ì‹¤", lat: 37.5255, lng: 126.9405, type: "ğŸš½" }
    ];
    facilities.forEach(f => {
        L.marker([f.lat, f.lng], {
            icon: L.divIcon({ html: `<div style="font-size:18px;">${f.type}</div>`, className: '', iconSize: [24, 24], iconAnchor: [12, 12] })
        }).bindPopup(`<b>${f.name}</b>`).addTo(map);
    });

    // [ì²´í¬] í•˜ë“œì½”ë”© ëª…ë‹¹
    const defaultSpots = [
        { id: "def1", name: "ë…¸ë“¤ì„¬ ì”ë””ë§ˆë‹¹", lat: 37.5175, lng: 126.9580, status: "ë³´í†µ", reason: "ê°• í•œê°€ìš´ë°ì„œ ì¦ê¸°ëŠ” íŒŒë…¸ë¼ë§ˆ ë·°", upvotes: 99, verified: true },
        { id: "def2", name: "ë§ˆí¬ëŒ€êµ ë³´ë„", lat: 37.5340, lng: 126.9365, status: "í˜¼ì¡", reason: "í˜„ì¥ê° ìµœê³ ! ì¸íŒŒ ì£¼ì˜", upvotes: 99, verified: true }
    ];

    // [ì²´í¬] ë°œì‚¬ ìœ„ì¹˜
    [[37.5338, 126.9355], [37.5300, 126.9390], [37.5265, 126.9425], [37.5200, 126.9495]].forEach(pos => {
        L.marker(pos, { icon: L.divIcon({ html: 'ğŸ‡', className: '', iconSize: [30, 30], iconAnchor: [15, 15] }) }).addTo(map);
        L.circle(pos, { color: '#ff4500', weight: 1, fillOpacity: 0.1, radius: 250 }).addTo(map);
    });

    const markers = {}; 

    function renderSpot(data, key) {
        if (data.reports && data.reports >= 1) { 
            if (markers[key]) map.removeLayer(markers[key]);
            return;
        }
        const isVerified = data.verified || (data.upvotes >= 3);
        const opacity = isVerified ? 1.0 : 0.45;
        const color = isVerified ? "#3498db" : "#95a5a6";
        const tag = isVerified ? '<span class="status-badge verified-tag">ì¸ì¦ë¨</span>' : '<span class="status-badge pending-tag">í™•ì¸ ì¤‘</span>';
        const icon = L.divIcon({
            html: `<div style="background:${color}; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; border:2px solid white; font-size:12px; opacity:${opacity}; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">â­</div>`,
            className: '', iconSize: [26, 26], iconAnchor: [13, 13]
        });
        const popupContent = `
            <div class="popup-form">
                <strong>${data.name}</strong> ${tag}<br>
                <div style="font-size:12px; color:#666; margin-top:3px;">í˜¼ì¡ë„: ${data.status}</div>
                <p style="font-size:12px; margin:8px 0;">${data.reason}</p>
                <div style="font-size:11px; color:#3498db;">ğŸ‘ ì¶”ì²œ: ${data.upvotes || 0}</div>
                ${!data.verified ? `
                <div class="vote-btn-group">
                    <button class="up-btn" onclick="handleVote('${key}', 'up')">ğŸ‘ ë§ì•„ìš”</button>
                    <button class="down-btn" onclick="handleVote('${key}', 'down')">âš ï¸ ì‹ ê³ </button>
                </div>` : ''}
            </div>`;
        if (markers[key]) {
            markers[key].setLatLng([data.lat, data.lng]).setIcon(icon).setPopupContent(popupContent);
        } else {
            markers[key] = L.marker([data.lat, data.lng], { icon: icon }).bindPopup(popupContent).addTo(map);
        }
    }

    defaultSpots.forEach(spot => renderSpot(spot, spot.id));
    database.ref('spots').on('value', (snapshot) => {
        const val = snapshot.val();
        for (let key in val) renderSpot(val[key], key);
    });

    // [GA ì—°ë™] íˆ¬í‘œ ì´ë²¤íŠ¸ ì¶”ì 
    window.handleVote = function(key, type) {
        gtag('event', 'vote_interaction', { 'vote_type': type });
        database.ref(`spots/${key}`).transaction((current) => {
            if (current) {
                if (type === 'up') {
                    current.upvotes = (current.upvotes || 0) + 1;
                    if (current.upvotes >= 3) current.verified = true;
                } else {
                    current.reports = (current.reports || 0) + 1;
                }
            }
            return current;
        });
    };

    let isAddMode = false;
    function toggleAddMode() {
        isAddMode = !isAddMode;
        if(isAddMode) gtag('event', 'click_add_start'); // [GA ì—°ë™] ì œë³´ ì‹œë„ ì¶”ì 
        const btn = document.getElementById('addBtn');
        btn.innerText = isAddMode ? "ì§€ë„ í„°ì¹˜" : "ğŸ“ ëª…ë‹¹ ì œë³´";
        btn.classList.toggle('active');
    }

    map.on('click', function(e) {
        if (!isAddMode) return;
        const id = Date.now();
        const content = `
            <div class="popup-form">
                <input type="text" id="name_${id}" placeholder="ì¥ì†Œ ì´ë¦„">
                <textarea id="reason_${id}" placeholder="ì¶”ì²œ ì´ìœ " rows="2"></textarea>
                <select id="status_${id}"><option value="ì¾Œì ">ğŸŸ¢ ì¾Œì </option><option value="ë³´í†µ" selected>ğŸŸ¡ ë³´í†µ</option><option value="í˜¼ì¡">ğŸ”´ í˜¼ì¡</option></select>
                <button class="save-btn" onclick="saveToFirebase(${e.latlng.lat}, ${e.latlng.lng}, ${id})">ë“±ë¡</button>
            </div>`;
        L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
        toggleAddMode();
    });

    window.saveToFirebase = function(lat, lng, id) {
        const name = document.getElementById(`name_${id}`).value;
        const reason = document.getElementById(`reason_${id}`).value;
        const status = document.getElementById(`status_${id}`).value;
        if(name && reason) {
            database.ref('spots').push({ name, reason, status, lat, lng, upvotes: 0, reports: 0, verified: false })
            .then(() => {
                gtag('event', 'complete_registration', { 'spot_name': name }); // [GA ì—°ë™] ë“±ë¡ ì„±ê³µ ì¶”ì 
                map.closePopup();
            });
        }
    };
</script>
</body>
</html>
