<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ì„œìš¸ ë¶ˆê½ƒì¶•ì œ ì‹¤ì‹œê°„ ëª…ë‹¹ ì§€ë„</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Pretendard', -apple-system, sans-serif; }
        body { background: #f8f9fa; color:#222; }
        .header { 
            background: linear-gradient(135deg,#ff6b6b,#ee5a6f); 
            color:#fff; padding:15px; text-align:center; 
            box-shadow:0 4px 15px rgba(0,0,0,0.1); 
            position: relative; z-index: 1001;
        }
        #map { width:100vw; height: calc(100vh - 82px); }

        /* [ì¤‘ìš”] ë¶ˆê½ƒ ì• ë‹ˆë©”ì´ì…˜ ì•„ì´ì½˜ CSS */
        .firework-icon {
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 30px !important;
            background: radial-gradient(circle, rgba(255,255,0,0.9) 0%, rgba(255,165,0,0.2) 70%);
            border-radius: 50%;
            border: 2px solid #ff4500;
            animation: firework-pulse 1.2s infinite;
            z-index: 1000 !important;
        }

        @keyframes firework-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.7); }
            70% { transform: scale(1.3); box-shadow: 0 0 20px 10px rgba(255, 69, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); }
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ ë° ë²„íŠ¼ */
        .control-panel { position: fixed; top:100px; right:20px; z-index:1000; }
        .add-btn { 
            padding:14px 24px; background:#4facfe; color:white; border:none; 
            border-radius:50px; cursor:pointer; font-weight:bold; font-size: 15px;
            box-shadow:0 6px 20px rgba(0,0,0,0.2); transition: 0.3s;
        }
        .add-btn:hover { transform: scale(1.05); background: #0088ff; }

        /* ë²”ë¡€ */
        .legend { 
            position: fixed; bottom:30px; left:20px; background:white; 
            padding:15px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,0.1); 
            z-index:1000; border: 1px solid #eee; font-size: 13px;
        }
        .legend-item { display:flex; align-items:center; gap:8px; margin:5px 0; }

        /* íŒì—… í¼ ìŠ¤íƒ€ì¼ */
        .popup-form { min-width: 200px; padding: 5px; }
        .popup-form h4 { margin-bottom: 10px; color: #333; }
        .popup-form input, .popup-form textarea, .popup-form select { 
            width: 100%; margin-bottom: 8px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;
        }
        .save-btn { 
            width: 100%; padding: 12px; background: #2ecc71; color: white; 
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer; 
        }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media screen and (max-width: 768px) {
            .legend { display:none; }
            .control-panel { top: auto; bottom: 30px; left: 50%; transform: translateX(-50%); right: auto; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ† ì‹¤ì‹œê°„ ë¶ˆê½ƒ ëª…ë‹¹ ì§€ë„ ğŸ‡</h1>
</div>

<div id="map"></div>

<div class="control-panel">
    <button class="add-btn" onclick="enableAddSpot()">ğŸ“ ë‚´ ëª…ë‹¹ ì œë³´í•˜ê¸°</button>
</div>

<div class="legend">
    <strong>ğŸ¨ ì•„ì´ì½˜ ì•ˆë‚´</strong>
    <div class="legend-item"><div style="font-size:18px">ğŸ‡</div> ë¶ˆê½ƒ ë°œì‚¬ ì§€ì </div>
    <div class="legend-item"><div style="background:#FFD700; width:18px; height:18px; border-radius:50%"></div> â­ ìµœê³  ëª…ë‹¹</div>
    <div class="legend-item"><div style="background:#C0C0C0; width:18px; height:18px; border-radius:50%"></div> âœ¨ ìš°ìˆ˜ ëª…ë‹¹</div>
    <div class="legend-item"><div style="background:#4facfe; width:18px; height:18px; border-radius:50%"></div> ğŸ“ ì¼ë°˜ ëª…ë‹¹</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
    // 1. Firebase ì„¤ì •
    const firebaseConfig = { databaseURL: "https://fireworks-map-50c05-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 2. ì§€ë„ ì´ˆê¸°í™” (ì—¬ì˜ë„ í•œê°•ê³µì› ì¤‘ì‹¬)
    const map = L.map('map', { zoomControl: false }).setView([37.5255, 126.9405], 14);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â©OpenStreetMap'
    }).addTo(map);

    // 3. ë¶ˆê½ƒ ë°œì‚¬ ì§€ì  (ğŸ‡) í‘œì‹œ í•¨ìˆ˜
    function addFireworkZones() {
        const fireworkZones = [
            { name: "ë©”ì¸ ë¶ˆê½ƒ ë°”ì§€ì„ ", coords: [37.5255, 126.9405] },
            { name: "ì„œë¸Œ ë¶ˆê½ƒ ë°”ì§€ì„ ", coords: [37.5228, 126.9472] }
        ];

        fireworkZones.forEach(zone => {
            // ì• ë‹ˆë©”ì´ì…˜ ë§ˆì»¤
            L.marker(zone.coords, { 
                icon: L.divIcon({
                    className: 'firework-icon',
                    html: 'ğŸ‡',
                    iconSize: [46, 46],
                    iconAnchor: [23, 23]
                }),
                zIndexOffset: 1000 
            }).addTo(map).bindPopup(`<b>${zone.name}</b><br>ë¶ˆê½ƒì´ ì—¬ê¸°ì„œ ë°œì‚¬ë©ë‹ˆë‹¤!`);

            // ë°˜ê²½ í‘œì‹œ
            L.circle(zone.coords, {
                color: '#ff4500', fillColor: '#ffcc00', fillOpacity: 0.15, radius: 250
            }).addTo(map);
        });
    }
    addFireworkZones();

    // 4. ì‚¬ìš©ì ë“±ê¸‰ë³„ ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜
    function getCustomIcon(rating) {
        let iconHtml = 'ğŸ“'; let bgColor = '#4facfe';
        if (rating === "â­â­â­â­â­") { iconHtml = 'â­'; bgColor = '#FFD700'; }
        else if (rating === "â­â­â­â­") { iconHtml = 'âœ¨'; bgColor = '#C0C0C0'; }
        
        return L.divIcon({
            html: `<div style="background:${bgColor}; width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px; color:white; border:2px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.2);">${iconHtml}</div>`,
            className: '', iconSize: [34, 34], iconAnchor: [17, 17]
        });
    }

    // 5. Firebase ë°ì´í„° ì‹¤ì‹œê°„ ë¡œë“œ
    database.ref('spots').on('child_added', (snapshot) => {
        const data = snapshot.val();
        L.marker([data.lat, data.lng], { icon: getCustomIcon(data.rating) })
            .bindPopup(`
                <div style="padding:5px">
                    <strong style="font-size:15px; color:#333;">${data.name}</strong><br>
                    <span style="color:#f39c12; font-size:12px;">${data.rating}</span>
                    <p style="margin-top:8px; font-size:13px; line-height:1.4;">${data.reason}</p>
                    <hr style="margin:8px 0; border:0; border-top:1px solid #eee;">
                    <small style="color:#999;">${new Date(data.time).toLocaleString()}</small>
                </div>
            `)
            .addTo(map);
    });

    // 6. ëª…ë‹¹ ì¶”ê°€ ë¡œì§
    window.enableAddSpot = function() {
        alert("ğŸ“ ì§€ë„ë¥¼ í´ë¦­í•´ì„œ ë‹¹ì‹ ì˜ ëª…ë‹¹ì„ ì°ì–´ì£¼ì„¸ìš”!");
        const drawHandler = new L.Draw.Marker(map);
        drawHandler.enable();
    };

    map.on(L.Draw.Event.CREATED, function (e) {
        const latlng = e.layer.getLatLng();
        const id = Date.now();
        
        const content = `
            <div class="popup-form">
                <h4>ğŸ“ ëª…ë‹¹ ì •ë³´ ì…ë ¥</h4>
                <input type="text" id="name_${id}" placeholder="ì¥ì†Œ ì´ë¦„ (ì˜ˆ: ì›íš¨ëŒ€êµ ë¶ë‹¨)">
                <textarea id="reason_${id}" placeholder="ì¶”ì²œ ì´ìœ  (ì˜ˆ: í™”ì¥ì‹¤ ê°€ê¹ê³  ì˜ ë³´ì—¬ìš”)" rows="3"></textarea>
                <select id="rating_${id}">
                    <option value="â­â­â­â­â­">â­ ìµœê³  ëª…ë‹¹ (ì‹œì•¼ ì¥ì•  ì—†ìŒ)</option>
                    <option value="â­â­â­â­" selected>âœ¨ ìš°ìˆ˜ ëª…ë‹¹ (ê´€ëŒ ì¾Œì )</option>
                    <option value="â­â­â­">ğŸ“ ì¼ë°˜ ëª…ë‹¹ (ë³¼ë§Œí•¨)</option>
                </select>
                <button class="save-btn" onclick="saveToFirebase(${latlng.lat}, ${latlng.lng}, ${id})">ì‹¤ì‹œê°„ ê³µìœ í•˜ê¸°</button>
            </div>
        `;
        L.popup().setLatLng(latlng).setContent(content).openOn(map);
    });

    // 7. Firebaseì— ì €ì¥
    window.saveToFirebase = function(lat, lng, id) {
        const name = document.getElementById(`name_${id}`).value;
        const reason = document.getElementById(`reason_${id}`).value;
        const rating = document.getElementById(`rating_${id}`).value;

        if(!name || !reason) return alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");

        database.ref('spots').push({
            name, reason, rating, lat, lng,
            time: new Date().toISOString()
        }).then(() => {
            map.closePopup();
        }).catch(err => alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message));
    };
</script>

</body>
</html>
