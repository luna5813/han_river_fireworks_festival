<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ì‹¤ì‹œê°„ ì—¬ì˜ë„ ë¶ˆê½ƒì¶•ì œ ëª…ë‹¹ ì§€ë„</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Pretendard', sans-serif; }
        .header { background: #1a1a2e; color:#fff; padding:15px; text-align:center; z-index: 1001; position: relative; border-bottom: 2px solid #ff6b6b; }
        #map { width:100vw; height: calc(100vh - 82px); background: #f0f0f0; }

        /* ë¶ˆê½ƒ ë°”ì§€ì„  ê¹œë¹¡ì„ íš¨ê³¼ */
        .firework-barge {
            background: #ff4500;
            border-radius: 50%;
            border: 2px solid #fff;
            animation: barge-flash 1s infinite alternate;
        }
        @keyframes barge-flash {
            from { opacity: 0.6; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1.2); box-shadow: 0 0 15px #ffeb3b; }
        }

        .control-panel { position: fixed; top:100px; right:20px; z-index:1000; }
        .add-btn { padding:14px 24px; background:#ff6b6b; color:white; border:none; border-radius:50px; cursor:pointer; font-weight:bold; box-shadow:0 4px 15px rgba(0,0,0,0.3); }
        .legend { position: fixed; bottom:30px; left:20px; background:white; padding:15px; border-radius:12px; z-index:1000; font-size: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        .popup-form input, .popup-form textarea, .popup-form select { width: 100%; margin-bottom: 8px; padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        .save-btn { width: 100%; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ† ì‹¤ì‹œê°„ ì—¬ì˜ë„ ë¶ˆê½ƒì¶•ì œ ëª…ë‹¹ ì§€ë„ ğŸ‡</h1>
</div>

<div id="map"></div>

<div class="control-panel">
    <button class="add-btn" onclick="enableAddSpot()">ğŸ“ ëª…ë‹¹ ì œë³´í•˜ê¸°</button>
</div>

<div class="legend">
    <div style="color: #ff4500; font-weight: bold; margin-bottom: 5px;">ğŸ”¥ ë¶ˆê½ƒ ë°œì‚¬ êµ¬ê°„ (ìˆ˜ìƒ ë°”ì§€ì„ )</div>
    <div style="width: 100%; height: 4px; background: orange; margin-bottom: 10px; opacity: 0.6;"></div>
    <div>â­ ìµœê³  ëª…ë‹¹ | âœ¨ ìš°ìˆ˜ ëª…ë‹¹ | ğŸ“ ì¼ë°˜ ëª…ë‹¹</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
    // 1. Firebase ì•”í˜¸í™” ì²˜ë¦¬ (Base64)
    // ì£¼ì†Œë¥¼ ì§ì ‘ ë…¸ì¶œí•˜ì§€ ì•Šê¸° ìœ„í•´ ì¸ì½”ë”©ëœ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const _0x4f2a = "aHR0cHM6Ly9maXJld29ya3MtbWFwLTUwYzA1LWRlZmF1bHQtcnRkYi.maXJlYmFzZWlvLmNvbS8="; 
    const firebaseConfig = { 
        databaseURL: atob(_0x4f2a.replace(".m", "Zm")) // ì‹¤í–‰ ì‹œì ì—ë§Œ ì£¼ì†Œ ë³µì›
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 2. OSM ê¸°ë°˜ ì§€ë„ ì´ˆê¸°í™”
    const map = L.map('map', { zoomControl: false }).setView([37.528, 126.940], 14);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // 3. ì‹¤ì œ ë¶ˆê½ƒ ë°œì‚¬ êµ¬ê°„ (ë§ˆí¬ëŒ€êµ ~ í•œê°•ì² êµ ìˆ˜ìƒ êµ¬ê°„)
    const bargeLine = [
        [37.5332, 126.9355], // ë§ˆí¬ëŒ€êµ ë¶€ê·¼
        [37.5295, 126.9380], // ì—¬ì˜ë„ê³µì› ì•
        [37.5255, 126.9410], // 63ë¹Œë”© ì• ë©”ì¸
        [37.5190, 126.9495]  // í•œê°•ì² êµ ë¶€ê·¼
    ];

    // ìˆ˜ìƒ ë°œì‚¬ ë¼ì¸ í‘œì‹œ
    L.polyline(bargeLine, { color: 'orange', weight: 4, opacity: 0.5, dashArray: '5, 10' }).addTo(map);

    // ë°”ì§€ì„  ìœ„ì¹˜ ì• ë‹ˆë©”ì´ì…˜ ë§ˆì»¤
    bargeLine.forEach((pos) => {
        L.circleMarker(pos, { radius: 7, className: 'firework-barge' })
            .addTo(map)
            .bindPopup("<b>ë¶ˆê½ƒ ë°œì‚¬ ë°”ì§€ì„  ì§€ì </b><br>ê°•ë¬¼ ìœ„ ìˆ˜ìƒì—ì„œ ë°œì‚¬ë©ë‹ˆë‹¤.");
    });

    // 4. ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜
    function getCustomIcon(rating) {
        let iconHtml = 'ğŸ“'; let bgColor = '#4facfe';
        if (rating === "â­â­â­â­â­") { iconHtml = 'â­'; bgColor = '#FFD700'; }
        else if (rating === "â­â­â­â­") { iconHtml = 'âœ¨'; bgColor = '#C0C0C0'; }
        return L.divIcon({
            html: `<div style="background:${bgColor}; width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px; color:white; border:2px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.2);">${iconHtml}</div>`,
            className: '', iconSize: [34, 34], iconAnchor: [17, 17]
        });
    }

    // 5. Firebase ì‹¤ì‹œê°„ ë™ê¸°í™”
    database.ref('spots').on('child_added', (snapshot) => {
        const data = snapshot.val();
        L.marker([data.lat, data.lng], { icon: getCustomIcon(data.rating) })
            .bindPopup(`<strong>${data.name}</strong><br>${data.rating}<p>${data.reason}</p>`)
            .addTo(map);
    });

    // 6. ëª…ë‹¹ ë“±ë¡ ê¸°ëŠ¥
    window.enableAddSpot = function() {
        alert("ì§€ë„ë¥¼ í´ë¦­í•´ì„œ ëª…ë‹¹ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”!");
        new L.Draw.Marker(map).enable();
    };

    map.on(L.Draw.Event.CREATED, function (e) {
        const latlng = e.layer.getLatLng();
        const id = Date.now();
        const content = `
            <div class="popup-form">
                <h4>ğŸ“ ëª…ë‹¹ ì •ë³´ ì…ë ¥</h4>
                <input type="text" id="name_${id}" placeholder="ì¥ì†Œ ëª…ì¹­">
                <textarea id="reason_${id}" placeholder="ì¶”ì²œ ì´ìœ " rows="2"></textarea>
                <select id="rating_${id}">
                    <option value="â­â­â­â­â­">â­ ìµœê³  ëª…ë‹¹</option>
                    <option value="â­â­â­â­" selected>âœ¨ ìš°ìˆ˜ ëª…ë‹¹</option>
                    <option value="â­â­â­">ğŸ“ ì¼ë°˜ ëª…ë‹¹</option>
                </select>
                <button class="save-btn" onclick="saveToFirebase(${latlng.lat}, ${latlng.lng}, ${id})">ê³µìœ í•˜ê¸°</button>
            </div>`;
        L.popup().setLatLng(latlng).setContent(content).openOn(map);
    });

    window.saveToFirebase = function(lat, lng, id) {
        const name = document.getElementById(`name_${id}`).value;
        const reason = document.getElementById(`reason_${id}`).value;
        const rating = document.getElementById(`rating_${id}`).value;
        if(name && reason) {
            database.ref('spots').push({ name, reason, rating, lat, lng, time: new Date().toISOString() })
            .then(() => map.closePopup());
        }
    };
</script>
</body>
</html>
