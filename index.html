<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ì„œìš¸ ë¶ˆê½ƒì¶•ì œ ì‹¤ì‹œê°„ ëª…ë‹¹ ì§€ë„</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Pretendard', sans-serif; background: #f0f2f5; color:#222; }
        .header { background: linear-gradient(135deg,#ff6b6b,#ee5a6f); color:#fff; padding:15px; text-align:center; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
        #map { width:100vw; height: calc(100vh - 85px); }
        
        /* ë¶ˆê½ƒ ì• ë‹ˆë©”ì´ì…˜ ì•„ì´ì½˜ CSS */
        .firework-icon {
            background: rgba(255, 255, 0, 0.3);
            border-radius: 50%;
            border: 2px solid #fff;
            animation: pulse 1.5s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 0, 0.7); }
            70% { transform: scale(1.3); box-shadow: 0 0 15px 15px rgba(255, 255, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 0, 0); }
        }

        /* ë²”ë¡€/íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .legend { position: fixed; bottom:30px; left:20px; background:#fff; padding:15px; border-radius:15px; box-shadow:0 8px 30px rgba(0,0,0,0.15); z-index:1000; border: 1px solid #eee; }
        .control-panel { position: fixed; top:100px; right:20px; z-index:500; }
        .add-btn { padding:12px 20px; background:#667eea; color:white; border:none; border-radius:30px; cursor:pointer; font-weight:bold; box-shadow:0 4px 15px rgba(102,126,234,0.4); }
        
        .popup-form input, .popup-form textarea, .popup-form select { width: 100%; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
        .save-btn { width: 100%; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        @media screen and (max-width: 768px) { .legend { display:none; } .control-panel { top: auto; bottom: 30px; right: 50%; transform: translateX(50%); width: 180px; } }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ† ì‹¤ì‹œê°„ ë¶ˆê½ƒ ëª…ë‹¹ ì»¤ë®¤ë‹ˆí‹° ğŸ‡</h1>
</div>

<div id="map"></div>

<div class="legend">
    <div style="margin-bottom:10px;"><strong>ğŸ”¥ ë¶ˆê½ƒ ë°œì‚¬ ì§€ì </strong></div>
    <div style="display:flex; align-items:center; gap:10px; font-size:13px;">
        <div style="width:20px; height:20px; background:yellow; border-radius:50%; border:2px solid orange;"></div> ë¶ˆê½ƒ ì—°ì¶œ êµ¬ì—­
    </div>
    <hr style="margin:10px 0; border:0; border-top:1px solid #eee;">
    <div style="font-size:12px; color:#666;">â­ ìµœê³  ëª…ë‹¹ | âœ¨ ìš°ìˆ˜ ëª…ë‹¹ | ğŸ“ ì¼ë°˜</div>
</div>

<div class="control-panel">
    <button class="add-btn" onclick="enableAddSpot()">+ ë‚´ ëª…ë‹¹ ê³µìœ í•˜ê¸°</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
    const firebaseConfig = { databaseURL: "https://fireworks-map-50c05-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const map = L.map('map', { zoomControl: false }).setView([37.525, 126.942], 14);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    // [ë¶ˆê½ƒì¶•ì œ êµ¬ì—­ ì•„ì´ì½˜]
    const fireworkIcon = L.divIcon({
        className: 'firework-icon',
        html: 'ğŸ‡',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });

    // ì‹¤ì œ ë¶ˆê½ƒ ì—°ì¶œ ì§€ì  (ì›íš¨ëŒ€êµ ~ í•œê°•ì² êµ ì‚¬ì´ ë°”ì§€ì„  ìœ„ì¹˜ ìœ„ì£¼)
    const fireworkZones = [
        { name: "ë©”ì¸ ë¶ˆê½ƒ ì—°ì¶œ ì§€ì  (ë°”ì§€ì„ )", coords: [37.5242, 126.9424] },
        { name: "ë³´ì¡° ë¶ˆê½ƒ ì—°ì¶œ ì§€ì ", coords: [37.5215, 126.9460] }
    ];

    fireworkZones.forEach(zone => {
        L.marker(zone.coords, { icon: fireworkIcon })
            .bindPopup(`<b style="font-size:15px;">${zone.name}</b><br>ì—¬ê¸°ì„œ ë¶ˆê½ƒì´ ë°œì‚¬ë©ë‹ˆë‹¤!`)
            .addTo(map);
        
        // ì—°ì¶œ ë°˜ê²½ í‘œì‹œ (ë…¸ë€ìƒ‰ ì›)
        L.circle(zone.coords, {
            color: 'orange',
            fillColor: '#ff0',
            fillOpacity: 0.2,
            radius: 200
        }).addTo(map);
    });

    // ëª…ë‹¹ ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜
    function getCustomIcon(rating) {
        let iconHtml = 'ğŸ“'; let bgColor = '#4facfe';
        if (rating === "â­â­â­â­â­") { iconHtml = 'â­'; bgColor = '#FFD700'; }
        else if (rating === "â­â­â­â­") { iconHtml = 'âœ¨'; bgColor = '#C0C0C0'; }
        
        return L.divIcon({
            html: `<div style="background:${bgColor}; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; color:white; border:2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">${iconHtml}</div>`,
            className: '', iconSize: [36, 36], iconAnchor: [18, 18]
        });
    }

    // Firebase ì‹¤ì‹œê°„ ì½ê¸°
    database.ref('spots').on('child_added', (snapshot) => {
        const data = snapshot.val();
        L.marker([data.lat, data.lng], { icon: getCustomIcon(data.rating) })
            .bindPopup(`<strong>${data.name}</strong><br>${data.rating}<br><p>${data.reason}</p>`)
            .addTo(map);
    });

    // ë“±ë¡ ë¡œì§
    window.enableAddSpot = function() {
        alert("ğŸ“ ì§€ë„ë¥¼ í´ë¦­í•´ì„œ ëª…ë‹¹ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”!");
        new L.Draw.Marker(map).enable();
    };

    map.on(L.Draw.Event.CREATED, function (e) {
        const latlng = e.layer.getLatLng();
        const id = Date.now();
        const content = `
            <div class="popup-form" style="width:200px">
                <h4>ìƒˆ ëª…ë‹¹ ë“±ë¡</h4>
                <input type="text" id="name_${id}" placeholder="ì¥ì†Œ ì´ë¦„">
                <textarea id="reason_${id}" placeholder="ì¶”ì²œ ì´ìœ " rows="2"></textarea>
                <select id="rating_${id}">
                    <option value="â­â­â­â­â­">â­ ìµœê³  ëª…ë‹¹</option>
                    <option value="â­â­â­â­" selected>âœ¨ ìš°ìˆ˜ ëª…ë‹¹</option>
                    <option value="â­â­â­">ğŸ“ ì¼ë°˜ ëª…ë‹¹</option>
                </select>
                <button class="save-btn" onclick="saveToFirebase(${latlng.lat}, ${latlng.lng}, ${id})">ê³µìœ í•˜ê¸°</button>
            </div>
        `;
        L.popup().setLatLng(latlng).setContent(content).openOn(map);
    });

    window.saveToFirebase = function(lat, lng, id) {
        const name = document.getElementById(`name_${id}`).value;
        const reason = document.getElementById(`reason_${id}`).value;
        const rating = document.getElementById(`rating_${id}`).value;
        if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");

        database.ref('spots').push({ name, reason, rating, lat, lng, time: new Date().toISOString() })
        .then(() => map.closePopup());
    };
</script>

</body>
</html>
