<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ì„œìš¸ ë¶ˆê½ƒì¶•ì œ ì‹¤ì‹œê°„ ëª…ë‹¹ ì§€ë„</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg,#1e3c72,#2a5298); color:#222; }
        .header { background: linear-gradient(135deg,#ff6b6b,#ee5a6f); color:#fff; padding:18px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.25); }
        #map { width:100vw; height: calc(100vh - 96px); }
        .legend { position: fixed; bottom:30px; left:30px; background:#fff; padding:16px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.25); z-index:1000; }
        .legend-item { display:flex; align-items:center; gap:10px; margin:8px 0; font-size:14px; }
        .legend-icon { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; }
        .filter-panel { position: fixed; top:110px; right:20px; background:#fff; padding:12px; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.18); z-index:500; width:200px; }
        .custom-popup .leaflet-popup-content-wrapper { background: linear-gradient(135deg,#667eea,#764ba2); color:#fff; border-radius:12px; }
        
        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media screen and (max-width: 768px) {
            .header h1 { font-size:18px; }
            .legend, .filter-panel { display:none; }
            .mobile-add-btn { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:1000; padding:15px 25px; background:#ff6b6b; color:#white; border-radius:30px; border:none; font-weight:bold; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ† ì‹¤ì‹œê°„ ë¶ˆê½ƒì¶•ì œ ëª…ë‹¹ ê³µìœ  ì§€ë„ ğŸ‡</h1>
    <p>ì‚¬ìš©ìë“¤ì´ ì§ì ‘ ë“±ë¡í•œ ëª…ë‹¹ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”!</p>
</div>

<div id="map"></div>

<div class="legend">
    <h3>ğŸ¯ ë§ˆì»¤ ì•ˆë‚´</h3>
    <div class="legend-item"><div class="legend-icon" style="background:#ff6b6b">â­</div><div>ê³µì‹ ì¶”ì²œ</div></div>
    <div class="legend-item"><div class="legend-icon" style="background:#7f8c8d">âœš</div><div>ì‚¬ìš©ì ì‹¤ì‹œê°„ ì œì•ˆ</div></div>
</div>

<div class="filter-panel">
    <button onclick="enableAddSpot()" style="width:100%; padding:10px; background:#667eea; color:white; border:none; border-radius:5px; cursor:pointer;">ğŸ“ ë‚´ ëª…ë‹¹ ê³µìœ í•˜ê¸°</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
    // 1. Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
        databaseURL: "https://fireworks-map-50c05-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 2. ì§€ë„ ì´ˆê¸° ì„¤ì •
    const map = L.map('map').setView([37.5248, 126.9471], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const userMarkersLayer = L.layerGroup().addTo(map);

    // ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜
    function createIcon(type) {
        const html = type === 'best' ? 'â­' : 'âœš';
        const color = type === 'best' ? '#ff6b6b' : '#7f8c8d';
        return L.divIcon({
            html: `<div style="background:${color};width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;color:white;border:2px solid white;">${html}</div>`,
            className: '', iconSize: [35, 35], iconAnchor: [17, 17]
        });
    }

    // 3. ê³ ì • ëª…ë‹¹ (ì˜ˆì‹œ ë°ì´í„°)
    const fixedSpots = [
        { name: "63ë¹Œë”© ì „ë§ëŒ€", coords: [37.5197, 126.9394], rating: "â­â­â­â­â­" },
        { name: "ì—¬ì˜ë„ í•œê°•ê³µì›", coords: [37.5265, 126.9342], rating: "â­â­â­â­" }
    ];
    fixedSpots.forEach(spot => {
        L.marker(spot.coords, { icon: createIcon('best') })
            .bindPopup(`<b>${spot.name}</b><br>${spot.rating}`)
            .addTo(map);
    });

    // 4. [í•µì‹¬] Firebase ì‹¤ì‹œê°„ ë°ì´í„° ì½ê¸°
    // ì„œë²„ì— ë°ì´í„°ê°€ ì¶”ê°€ë˜ë©´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ ì§€ë„ì— ë§ˆì»¤ë¥¼ ì°ìŠµë‹ˆë‹¤.
    database.ref('spots').on('child_added', (snapshot) => {
        const data = snapshot.val();
        const marker = L.marker([data.lat, data.lng], { icon: createIcon('user') })
            .bindPopup(`
                <div style="min-width:150px">
                    <h4 style="margin:0;color:#667eea">${data.name}</h4>
                    <p style="margin:5px 0"><b>ë“±ê¸‰:</b> ${data.rating}</p>
                    <p style="margin:0"><b>ì´ìœ :</b> ${data.reason}</p>
                </div>
            `);
        userMarkersLayer.addLayer(marker);
    });

    // 5. ëª…ë‹¹ ë“±ë¡ ê¸°ëŠ¥
    let drawHandler = null;
    window.enableAddSpot = function() {
        alert("ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ëª…ë‹¹ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”!");
        drawHandler = new L.Draw.Marker(map);
        drawHandler.enable();
    };

    map.on(L.Draw.Event.CREATED, function (e) {
        const latlng = e.layer.getLatLng();
        const uniqueId = Date.now();
        
        const popupContent = `
            <div id="form_${uniqueId}" style="padding:5px">
                <h4 style="margin-bottom:8px">ğŸ“ ìƒˆë¡œìš´ ëª…ë‹¹ ë“±ë¡</h4>
                <input type="text" id="name_${uniqueId}" placeholder="ì¥ì†Œ ì´ë¦„" style="width:100%;margin-bottom:5px"><br>
                <textarea id="reason_${uniqueId}" placeholder="ì¶”ì²œ ì´ìœ " style="width:100%;margin-bottom:5px"></textarea><br>
                <select id="rating_${uniqueId}" style="width:100%;margin-bottom:8px">
                    <option value="â­â­â­â­â­">ìµœê³  ëª…ë‹¹</option>
                    <option value="â­â­â­â­">ìš°ìˆ˜ ëª…ë‹¹</option>
                    <option value="â­â­â­">ì¼ë°˜ ëª…ë‹¹</option>
                </select>
                <button onclick="saveToFirebase(${latlng.lat}, ${latlng.lng}, ${uniqueId})" style="width:100%;background:#2ecc71;color:white;border:none;padding:5px;border-radius:3px;cursor:pointer">ê³µìœ í•˜ê¸°</button>
            </div>
        `;

        L.popup().setLatLng(latlng).setContent(popupContent).openOn(map);
    });

    // 6. [í•µì‹¬] Firebaseì— ë°ì´í„° ì €ì¥í•˜ê¸°
    window.saveToFirebase = function(lat, lng, id) {
        const name = document.getElementById(`name_${id}`).value;
        const reason = document.getElementById(`reason_${id}`).value;
        const rating = document.getElementById(`rating_${id}`).value;

        if(!name) return alert("ì¥ì†Œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");

        database.ref('spots').push({
            name, reason, rating, lat, lng,
            time: new Date().toISOString()
        }).then(() => {
            alert("ê³µìœ  ì™„ë£Œ! ëª¨ë“  ì‚¬ìš©ìì˜ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤.");
            map.closePopup();
        }).catch(err => {
            alert("ì €ì¥ ì‹¤íŒ¨: " + err.message);
        });
    };
</script>

</body>
</html>
